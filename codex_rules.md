# ü§ñ Codex Rules (JuicyFox)

## üìå –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ  
Codex –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ **—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–¥–∞**.  
–ó–∞–¥–∞—á–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç GPTS, Codex –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∏—Ö —Å—Ç—Ä–æ–≥–æ –ø–æ —ç—Ç–∏–º –ø—Ä–∞–≤–∏–ª–∞–º.  

---

## ‚öñÔ∏è Safety-Contract

### 1. –ì–¥–µ –º–æ–∂–Ω–æ –ø—Ä–∞–≤–∏—Ç—å  
- ‚úÖ –¢–æ–ª—å–∫–æ –≤ —Ñ–∞–π–ª–∞—Ö/–º–æ–¥—É–ª—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑–∞–Ω—ã –≤ –∑–∞–¥–∞—á–µ.  
- ‚úÖ –ù–æ–≤—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–∫–ª—é—á–µ–Ω—ã –≤ REGION-–º–∞—Ä–∫–µ—Ä—ã:  
  ```python
  # REGION AI: <–æ–ø–∏—Å–∞–Ω–∏–µ>
  ... –∫–æ–¥ ...
  # END REGION AI
  ```  
- ‚úÖ SQL-–ø—Ä–∞–≤–∫–∏:  
  - –ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **alembic** ‚Üí –ø—Ä–∞–≤–∫–∏ —Ç–æ–ª—å–∫–æ –≤ `alembic/versions/`.  
  - –ï—Å–ª–∏ alembic –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ‚Üí –ø—Ä–∞–≤–∫–∏ –≤ `shared/db/schema.sql`.  
- üö´ –ó–∞–ø—Ä–µ—â–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `env`, `requirements`, `Dockerfile`, CI/CD, –º–∏–≥—Ä–∞—Ü–∏—è—Ö (–∫—Ä–æ–º–µ alembic), secrets.  

### 2. –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å  
- ‚úÖ –í—Å—Ç–∞–≤–∫–∞ –∏ –∑–∞–º–µ–Ω–∞ –∫–æ–¥–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞.  
- ‚úÖ –ò–º–ø–æ—Ä—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ –≤ `# REGION: imports`.  
- üö´ –ù–µ –º–µ–Ω—è—Ç—å —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –ø—É–±–ª–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π/–∫–ª–∞—Å—Å–æ–≤ –±–µ–∑ —è–≤–Ω–æ–≥–æ —É–∫–∞–∑–∞–Ω–∏—è.  
- üö´ –ù–µ —Ç—Ä–æ–≥–∞—Ç—å FSM/Router namespace –∏ –∏–º–µ–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π.  
- üö´ –ù–µ —Ö–∞—Ä–¥–∫–æ–¥–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã, URL, —Ç–æ–∫–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏ –∏ ENV.  

### 3. –û–±—ä—ë–º –∏–∑–º–µ–Ω–µ–Ω–∏–π  
- ‚úÖ Œî ‚â§50 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ (–±–µ–∑ —É—á—ë—Ç–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤/–ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫).  
- ‚úÖ ‚â§2 hunks (–∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –±–ª–æ–∫–∞) –Ω–∞ PR.  
- üö´ –ú–∞—Å—Å–æ–≤—ã–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∏ –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–µ—â–µ–Ω—ã.  

### 4. –§–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞  
- ‚úÖ **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é**: –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ **Pull Request (PR)** ‚Äî –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥, –æ–∫—Ä—É–∂—ë–Ω–Ω—ã–π REGION-–º–∞—Ä–∫–µ—Ä–∞–º–∏.  
- ‚úÖ –î–æ–ø—É—Å—Ç–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **diff-—Ñ–æ—Ä–º–∞—Ç** (`+`/`-` –ø—Ä–µ—Ñ–∏–∫—Å—ã), –µ—Å–ª–∏ —ç—Ç–æ —É–¥–æ–±–Ω–µ–µ –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π.  
- ‚úÖ –í –æ–±–æ–∏—Ö —Å–ª—É—á–∞—è—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å changelog-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (1‚Äì3 —Å—Ç—Ä–æ–∫–∏: —á—Ç–æ –∏ –∑–∞—á–µ–º).  
- ‚úÖ –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è diff-—Ñ–æ—Ä–º–∞—Ç, —Å—Ç—Ä–æ–∫–∏ —Å `+`/`-` –¥–æ–ª–∂–Ω—ã –æ—Ç—Ä–∞–∂–∞—Ç—å **—Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**, –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.  
- ‚úÖ –°—Ç–∏–ª—å –∫–æ–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è (PEP8, –æ—Ç—Å—Ç—É–ø—ã, –∫–∞–≤—ã—á–∫–∏).  

### 5. –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã  
- ‚úÖ –ú–æ–¥—É–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è (`python -c "import <module>").  
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è –≤–∞–ª–∏–¥–Ω—ã–º–∏.  
- ‚úÖ FSM –∏ handlers –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ—Ç–µ—Ä—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.  
- ‚úÖ –õ–æ–≥–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∏ —Å–æ–±—ã—Ç–∏–π –æ—Å—Ç–∞—ë—Ç—Å—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π.  
- üö´ –ù–µ —É–¥–∞–ª—è—Ç—å –∏ –Ω–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ API, –º–æ–¥–µ–ª–∏ –∏ –ø–æ–ª—è –ë–î.  

### 6. –ê–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ–¥ PR  
- ‚úÖ –õ–∏–Ω—Ç–µ—Ä: `ruff/flake8` –Ω–∞ –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–º —Ñ–∞–π–ª–µ.  
- ‚úÖ –ò–º–ø–æ—Ä—Ç-—á–µ–∫:  
  ```bash
  python -c "import importlib; importlib.import_module('<module>')"
  ```  
- ‚úÖ Smoke-—Ç–µ—Å—Ç (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ):  
  ```bash
  uvicorn api.webhook:app --port 0
  ```  
- ‚úÖ Unit-—Ç–µ—Å—Ç—ã (`pytest`) –Ω–∞ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö.  

---

## üì¶ –ß—Ç–æ –º–æ–∂–Ω–æ / –Ω–µ–ª—å–∑—è

| ‚úÖ –ú–æ–∂–Ω–æ | üö´ –ù–µ–ª—å–∑—è |
|---------|-----------|
| –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ `modules/*/handlers.py` | –ú–µ–Ω—è—Ç—å `apps/bot_core/main.py` |
| –†–∞—Å—à–∏—Ä—è—Ç—å Enum —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ `apps/bot_core/state.py` | –£–¥–∞–ª—è—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è |
| –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ UI-—ç–ª–µ–º–µ–Ω—Ç—ã –≤ `keyboards.py` | –•–∞—Ä–¥–∫–æ–¥–∏—Ç—å —Ç–æ–∫–µ–Ω—ã/URL |
| –î–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –≤ `locales/*.json` | –õ–æ–º–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å API |
| –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –≤ `modules/payments/providers/` | –ò–∑–º–µ–Ω—è—Ç—å `requirements*.txt` |
| –î–æ–±–∞–≤–ª—è—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ `alembic/versions/` | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å secrets, env |  

---

## üìå –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ Codex  

‚ö†Ô∏è –≠—Ç–æ **—Ç–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è**, –æ–Ω **–Ω–µ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–¥–∞**.  

**–í–∞—Ä–∏–∞–Ω—Ç 1 ‚Äî PR-—Ñ–æ—Ä–º–∞—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**

```sql
# fix: –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ pending_invoices –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–ª–∞—Ç–µ–∂–µ–π

# REGION AI: pending_invoices table
CREATE TABLE pending_invoices (
    invoice_id TEXT PRIMARY KEY,
    user_id INTEGER NOT NULL,
    plan_code TEXT NOT NULL,
    currency TEXT NOT NULL,
    price REAL NOT NULL,
    plan_name TEXT,
    plan_callback TEXT,
    period INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
# END REGION AI
```

**–í–∞—Ä–∏–∞–Ω—Ç 2 ‚Äî Diff-—Ñ–æ—Ä–º–∞—Ç (—Ç–∞–∫–∂–µ —Ä–∞–∑—Ä–µ—à—ë–Ω):**

```diff
# fix: –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ pending_invoices –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–ª–∞—Ç–µ–∂–µ–π
+ CREATE TABLE pending_invoices (
+     invoice_id TEXT PRIMARY KEY,
+     user_id INTEGER NOT NULL,
+     plan_code TEXT NOT NULL,
+     currency TEXT NOT NULL,
+     price REAL NOT NULL,
+     plan_name TEXT,
+     plan_callback TEXT,
+     period INTEGER,
+     created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
+ );
```

---

## ‚ö° Cheatsheet (—à–ø–∞—Ä–≥–∞–ª–∫–∞ Codex)

- Œî ‚â§50 —Å—Ç—Ä–æ–∫, ‚â§2 hunks.  
- –¢–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã/–æ–±–ª–∞—Å—Ç–∏ –∏–∑ –∑–∞–¥–∞—á–∏.  
- –í—Å–µ –Ω–æ–≤—ã–µ –±–ª–æ–∫–∏ ‚Üí REGION-–º–∞—Ä–∫–µ—Ä—ã.  
- SQL ‚Üí —Ç–æ–ª—å–∫–æ –≤ alembic (–µ—Å–ª–∏ –µ—Å—Ç—å).  
- –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Üí **PR –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**, diff ‚Äî –¥–æ–ø—É—Å—Ç–∏–º –∫–∞–∫ fallback.  
- –ü—Ä–æ–≤–µ—Ä–∫–∏: flake8 + pytest + –∏–º–ø–æ—Ä—Ç.  

---

üëâ –≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —á–∏—Å—Ç–æ –¥–ª—è Codex.  
GPTS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª `GPTS_RULES.md` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–¥–∞—á.

