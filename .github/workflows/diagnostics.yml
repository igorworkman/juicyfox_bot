name: Diagnostics

on:
  workflow_dispatch:   # запуск вручную через GitHub Actions

jobs:
  diagnose:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Check ENV variables
        run: |
          echo "Checking required ENV vars..."
          if [ ! -f .env ]; then
            echo "❌ .env not found"; exit 1
          fi
          grep -E "TELEGRAM_TOKEN|BOT_ID|BASE_URL" .env || echo "⚠️ Missing one of required env vars"

      - name: Start server in background
        run: |
          source .venv/bin/activate
          nohup python -m uvicorn apps.bot_core.main:app --host 0.0.0.0 --port 8000 --env-file .env > server.log 2>&1 &
          sleep 7
          echo "Server started, logs:"
          cat server.log

      - name: Test local endpoints
        run: |
          echo "==> /healthz"
          curl -s http://127.0.0.1:8000/healthz || true
          echo "==> /readyz"
          curl -s http://127.0.0.1:8000/readyz || true
          echo "==> /livez"
          curl -s http://127.0.0.1:8000/livez || true

      - name: Test Telegram getMe
        run: |
          TOKEN=$(grep TELEGRAM_TOKEN .env | cut -d '=' -f2)
          if [ -z "$TOKEN" ]; then
            echo "❌ TELEGRAM_TOKEN not set in .env"; exit 1
          fi
          echo "==> Testing Telegram API with provided token"
          curl -s "https://api.telegram.org/bot${TOKEN}/getMe" || true
